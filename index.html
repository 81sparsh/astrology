<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D1 & D9 Chart Reader with Gemini</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      padding: 40px;
      max-width: 800px;
      margin: auto;
    }

    h2 {
      color: #222;
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 15px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    button {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 25px;
    }

    button:hover {
      background-color: #0056b3;
    }

    .section {
      background: white;
      padding: 20px;
      margin-top: 30px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 8px;
      text-align: left;
    }

    pre {
      background: #f1f1f1;
      padding: 10px;
      border-radius: 6px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
  </style>
</head>
<body>

  <h2>Astrology Chart (D1 & D9) + Gemini Analysis</h2>

  <form id="astroForm">
    <label>Date of Birth:
      <input type="date" name="dob" required>
    </label>

    <label>Time of Birth:
      <input type="time" name="tob" required>
    </label>

    <label>Location (City in India):
      <input type="text" name="location" placeholder="e.g. Panchkula" required>
    </label>

    <label>Timezone:
      <select name="timezone" required>
        <option value="5.5" selected>India Standard Time (IST) +5:30</option>
      </select>
    </label>

    

    <button type="submit">Generate Chart & Analyze</button>
  </form>

  <div class="section">
    <h2>D1 Chart Info</h2>
    <div id="d1Table">Awaiting input...</div>
  </div>

  <div class="section">
    <h2>D9 Chart Info</h2>
    <div id="d9Table">Awaiting input...</div>
  </div>

  <div class="section">
    <h2>üß† Gemini Analysis</h2>
    <pre id="geminiResult">Awaiting analysis...</pre>
  </div>

  <script>
    const ASTROLOGY_API_KEY = "QW7HuNu0zm9rZmIfCd9xM2m0bcNdYPti4GsIHH2J";
    const GEMINI_API_KEY = "AIzaSyCQ8UKs9qDqv3137MEXes-8RcRk5MU--4I";

    async function getCoordinates(location) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', India')}`);
      const data = await res.json();
      if (!data.length) throw new Error("Location not found");
      return {
        lat: parseFloat(data[0].lat),
        lng: parseFloat(data[0].lon),
      };
    }

    function generateTable(data) {
      if (!Array.isArray(data)) return "<p>No data found.</p>";

      let table = "<table><tr>";
      Object.keys(data[0]).forEach(key => table += `<th>${key}</th>`);
      table += "</tr>";

      data.forEach(row => {
        table += "<tr>";
        Object.values(row).forEach(value => {
          table += `<td>${value}</td>`;
        });
        table += "</tr>";
      });

      table += "</table>";
      return table;
    }

    document.getElementById("astroForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = new FormData(this);
      const dob = new Date(form.get("dob") + "T" + form.get("tob"));
      const location = form.get("location");

      const d1Table = document.getElementById("d1Table");
      const d9Table = document.getElementById("d9Table");
      const geminiResult = document.getElementById("geminiResult");

      d1Table.innerHTML = "Loading D1 Chart...";
      d9Table.innerHTML = "Loading D9 Chart...";
      geminiResult.textContent = "Analyzing...";

      try {
        const coords = await getCoordinates(location);

        const payload = {
          year: dob.getFullYear(),
          month: dob.getMonth() + 1,
          date: dob.getDate(),
          hours: dob.getHours(),
          minutes: dob.getMinutes(),
          seconds: 0,
          latitude: coords.lat,
          longitude: coords.lng,
          timezone: parseFloat(form.get("timezone")),
          settings: {
            observation_point: "topocentric",
            ayanamsha: "lahiri",
            language: form.get("language")
          }
        };

        const [d1Res, d9Res] = await Promise.all([
          fetch("https://json.freeastrologyapi.com/planets/extended", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": ASTROLOGY_API_KEY
            },
            body: JSON.stringify(payload)
          }),
          fetch("https://json.freeastrologyapi.com/navamsa-chart-info", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": ASTROLOGY_API_KEY
            },
            body: JSON.stringify(payload)
          })
        ]);

        const d1Data = await d1Res.json();
        const d9Data = await d9Res.json();

        const d1Formatted = d1Data.output || [];
        const d9Formatted = d9Data.output || [];

        d1Table.innerHTML = generateTable(d1Formatted);
        d9Table.innerHTML = generateTable(d9Formatted);

        const combinedText = `Location: ${location}\n\nüåü D1 Chart:\n${JSON.stringify(d1Formatted, null, 2)}\n\nüåå D9 Chart:\n${JSON.stringify(d9Formatted, null, 2)}`;

        const geminiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Please analyze the following D1 and D9 astrology chart data:\n\n${combinedText}` }] }]
          })
        });

        const geminiJson = await geminiResponse.json();
        const analysis = geminiJson.candidates?.[0]?.content?.parts?.[0]?.text || "Gemini analysis not available.";

        geminiResult.textContent = analysis;

      } catch (err) {
        d1Table.innerHTML = d9Table.innerHTML = "";
        geminiResult.textContent = "‚ùå Error: " + err.message;
        console.error(err);
      }
    });
  </script>

</body>
</html>
